# Sơ Đồ Kiến Trúc NovaCinema

## Tổng Quan Hệ Thống

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   Browser   │────────▶│   Frontend  │────────▶│   Backend   │
│  (Client)   │         │   (React)   │   API   │  (NestJS)   │
└─────────────┘         └─────────────┘         └──────┬──────┘
                                                        │
                                                        ▼
                                                 ┌──────────────┐
                                                 │   MongoDB    │
                                                 │   Database   │
                                                 └──────────────┘
```

---

## Kiến Trúc 3 Tầng Backend

```
┌────────────────────────────────────────────────────────────────────┐
│                        TẦNG GIAO DIỆN                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │  Movies  │  │ Theaters │  │Showtimes │  │ Bookings │         │
│  │Controller│  │Controller│  │Controller│  │Controller│         │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘         │
│       │             │              │             │                │
│  ┌────┴──────────────┴──────────────┴─────────────┴─────┐        │
│  │        Guards, Interceptors, Pipes, Filters          │        │
│  └───────────────────────────────────────────────────────┘        │
└──────────────────────────────┬─────────────────────────────────────┘
                               │
┌──────────────────────────────▼─────────────────────────────────────┐
│                       TẦNG NGHIỆP VỤ                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │  Movie   │  │ Theater  │  │Showtime  │  │ Booking  │         │
│  │ Service  │  │ Service  │  │ Service  │  │ Service  │         │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘         │
│       │             │              │             │                │
│  ┌────┴──────────────────────────────────────────┴─────┐         │
│  │         Use Cases (Nghiệp Vụ Phức Tạp)             │         │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐     │         │
│  │  │    Tạo     │ │  Xác Nhận  │ │    Hủy     │     │         │
│  │  │  Booking   │ │  Booking   │ │  Booking   │     │         │
│  │  └────────────┘ └────────────┘ └────────────┘     │         │
│  └──────────────────────────────────────────────────────┘         │
└──────────────────────────────┬─────────────────────────────────────┘
                               │
┌──────────────────────────────▼─────────────────────────────────────┐
│                    TẦNG TRUY CẬP DỮ LIỆU                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │  Movie   │  │ Theater  │  │Showtime  │  │ Booking  │         │
│  │Repository│  │Repository│  │Repository│  │Repository│         │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘         │
│       │             │              │             │                │
│  ┌────┴──────────────┴──────────────┴─────────────┴─────┐        │
│  │      Base Repository (Các Thao Tác CRUD)             │        │
│  └───────────────────────────────────────────────────────┘        │
│  ┌────────────────────────────────────────────────────────┐       │
│  │           MongoDB Schemas & Collections                │       │
│  └────────────────────────────────────────────────────────┘       │
└──────────────────────────────┬─────────────────────────────────────┘
                               │
                        ┌──────▼──────┐
                        │   MongoDB   │
                        │  Database   │
                        └─────────────┘

┌────────────────────────────────────────────────────────────────────┐
│                         TẦNG DOMAIN                                │
│                   (Độc Lập Framework)                              │
│  ┌──────────────────────────────────────────────────────────┐     │
│  │                 Domain Models                             │     │
│  │  Movie | Theater | Room | Seat | User | Showtime | Booking    │
│  │  (Entities nghiệp vụ thuần túy với methods)              │     │
│  └──────────────────────────────────────────────────────────┘     │
│  ┌──────────────────────────────────────────────────────────┐     │
│  │              Domain Interfaces                            │     │
│  │  Repository Contracts | Service Contracts                │     │
│  └──────────────────────────────────────────────────────────┘     │
└────────────────────────────────────────────────────────────────────┘
```

---

## Luồng Request: Tạo Booking

```
┌────────┐
│ Client │
└───┬────┘
    │ POST /api/bookings
    │ { showtimeId, seatIds }
    ▼
┌──────────────────┐
│ BookingsController│◄─── 1. Tầng Giao Diện
└───┬──────────────┘     - Validate DTO
    │                    - Lấy user từ JWT
    │                    - Gọi service
    ▼
┌──────────────────┐
│  BookingService  │◄─── 2. Service Layer
└───┬──────────────┘     - Ủy thác cho use case
    │
    ▼
┌─────────────────────┐
│CreateBookingUseCase │◄── 3. Use Case (Logic Nghiệp Vụ)
└───┬─────────────────┘    - Validate showtime tồn tại
    │                      - Kiểm tra ghế còn trống
    │                      - Tính giá
    │                      - Tạo booking
    ├──────────┬──────────┬─────────┐
    ▼          ▼          ▼         ▼
┌─────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│Showtime │ │  Seat  │ │Booking │ │Showtime│
│Repository│ │Repository│ │Repository│ │Repository│◄── 4. Tầng Dữ Liệu
└─────────┘ └────────┘ └────────┘ └────────┘    - Database queries
    │          │          │         │            - Entity mapping
    └──────────┴──────────┴─────────┘
               │
               ▼
         ┌──────────┐
         │ MongoDB  │◄───── 5. Database
         └──────────┘
               │
               │ Trả về dữ liệu
               ▼
    ┌──────────────────┐
    │   Booking Entity │◄──── 6. Response
    │  với booking code│
    └──────────────────┘
               │
               ▼
         ┌─────────┐
         │ Client  │
         └─────────┘
```

---

## Quan Hệ Domain Models

```
        ┌───────────┐
        │  Theater  │
        │   (Rạp)   │
        └─────┬─────┘
              │ 1
              │ có nhiều
              │ N
        ┌─────▼─────┐
        │   Room    │
        │  (Phòng)  │
        └─────┬─────┘
              │ 1
              ├─có nhiều─┐
              │          │ N
              │ N        │
        ┌─────▼───┐  ┌───▼──────┐
        │  Seat   │  │ Showtime │
        │ (Ghế)   │  │(Lịch chiếu)│
        └─────────┘  └─────┬────┘
              │            │
              │            │ N
              │            │ thuộc về
              │            │ 1
              │      ┌─────▼─────┐
              │      │   Movie   │
              │      │  (Phim)   │
              │      └───────────┘
              │
              │ N
              │ được chọn trong
              │ 1
        ┌─────▼─────┐
        │  Booking  │
        │ (Đặt vé)  │
        └─────┬─────┘
              │ N
              │ thuộc về
              │ 1
        ┌─────▼─────┐
        │   User    │
        │(Người dùng)│
        └───────────┘
```

---

## Kiến Trúc Frontend

```
┌────────────────────────────────────────────────────────────┐
│                       COMPONENTS                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  Movie   │  │ Showtime │  │ Booking  │  │  Common  │ │
│  │Components│  │Components│  │Components│  │Components│ │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │
└───────┼─────────────┼─────────────┼─────────────┼────────┘
        │             │             │             │
┌───────▼─────────────▼─────────────▼─────────────▼────────┐
│                    CUSTOM HOOKS                           │
│  useMovies() | useShowtimes() | useBooking() | useAuth() │
└───────┬───────────────────────────────────────┬──────────┘
        │                                       │
┌───────▼───────────────────────────────────────▼──────────┐
│                 QUẢN LÝ STATE                             │
│              (Zustand / React Context)                    │
│  authStore | bookingStore | ...                          │
└───────┬───────────────────────────────────────┬──────────┘
        │                                       │
┌───────▼───────────────────────────────────────▼──────────┐
│                    API CLIENT                             │
│  ┌────────────────────────────────────────────────────┐  │
│  │      Axios Instance (với interceptors)             │  │
│  └─────┬──────────────────────────────────────────────┘  │
│        │                                                  │
│  ┌─────▼─────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐│
│  │  Movies   │  │Showtimes │  │ Bookings │  │  Auth   ││
│  │    API    │  │   API    │  │   API    │  │  API    ││
│  └───────────┘  └──────────┘  └──────────┘  └─────────┘│
└───────┬─────────────────────────────────────────────────┘
        │ HTTP/HTTPS
        ▼
┌────────────────┐
│  Backend API   │
│ (NestJS REST)  │
└────────────────┘
```

---

## Luồng Xác Thực

```
┌────────┐         ┌──────────┐         ┌──────────┐
│ Client │         │ Frontend │         │ Backend  │
└───┬────┘         └─────┬────┘         └────┬─────┘
    │                    │                   │
    │ 1. Đăng nhập       │                   │
    ├───────────────────▶│                   │
    │                    │ 2. POST /auth/login
    │                    ├──────────────────▶│
    │                    │                   │ 3. Validate
    │                    │                   │    credentials
    │                    │ 4. Trả về tokens  │
    │                    │◄──────────────────┤
    │                    │ { accessToken,    │
    │                    │   refreshToken }  │
    │ 5. Lưu tokens vào  │                   │
    │    localStorage    │                   │
    │◄───────────────────┤                   │
    │                    │                   │
    │ 6. API Request     │                   │
    │    (với token)     │                   │
    ├───────────────────▶│ 7. Thêm Bearer token
    │                    ├──────────────────▶│
    │                    │  Authorization:   │
    │                    │  Bearer {token}   │
    │                    │                   │ 8. Validate JWT
    │                    │ 9. Trả về dữ liệu │
    │                    │◄──────────────────┤
    │ 10. Hiển thị data  │                   │
    │◄───────────────────┤                   │
    │                    │                   │
    │ Nếu 401 Unauthorized│                  │
    │                    │ 11. Refresh token │
    │                    ├──────────────────▶│
    │                    │ { refreshToken }  │
    │                    │ 12. Access token  │
    │                    │     mới           │
    │                    │◄──────────────────┤
    │                    │ 13. Thử lại       │
    │                    │     request       │
    │                    ├──────────────────▶│
    │                    │                   │
```

---

## State Machine Của Booking

```
                ┌──────────┐
                │  Pending │ (Timer 15 phút)
                │ Chờ xử lý│
                └────┬─────┘
                     │
         ┌───────────┼───────────┐
         │           │           │
         │           │           │
    ┌────▼────┐  ┌───▼────┐  ┌──▼─────┐
    │Confirmed│  │Cancelled│  │Expired │
    │Đã xác   │  │  Đã hủy │  │Hết hạn │
    │nhận     │  │(Người   │  │(Timeout)│
    │(Đã trả) │  │ dùng)   │  │        │
    └────┬────┘  └─────────┘  └────────┘
         │
         │ (Có thể hủy nếu >2h)
         │
    ┌────▼────┐
    │Cancelled│
    │ Đã hủy  │
    │(Hoàn $) │
    └─────────┘
```

---

## Collections & Indexes Database

```
┌─────────────────────────────────────────────────┐
│ Collections (Bảng):                             │
│                                                 │
│ ┌───────────┐  ┌──────────┐  ┌──────────┐     │
│ │   users   │  │  movies  │  │ theaters │     │
│ │(Người dùng)│  │  (Phim)  │  │  (Rạp)   │     │
│ └───────────┘  └──────────┘  └──────────┘     │
│                                                 │
│ ┌───────────┐  ┌──────────┐  ┌──────────┐     │
│ │   rooms   │  │  seats   │  │showtimes │     │
│ │  (Phòng)  │  │  (Ghế)   │  │(Lịch     │     │
│ │           │  │          │  │ chiếu)   │     │
│ └───────────┘  └──────────┘  └──────────┘     │
│                                                 │
│ ┌───────────┐  ┌──────────┐                    │
│ │ bookings  │  │   otps   │                    │
│ │ (Đặt vé)  │  │(Mã OTP)  │                    │
│ └───────────┘  └──────────┘                    │
│                                                 │
│ Indexes Chính:                                  │
│ • users: email (unique)                         │
│ • movies: releaseDate, endDate                  │
│ • showtimes: movieId, theaterId, startTime      │
│ • bookings: userId, showtimeId, bookingCode     │
└─────────────────────────────────────────────────┘
```
